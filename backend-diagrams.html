<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Architecture - GPX Application</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        // Sistema de Zoom y Pan para Diagramas
        class DiagramController {
            constructor() {
                this.initializeAfterMermaid();
            }

            initializeAfterMermaid() {
                const checkMermaid = () => {
                    const diagrams = document.querySelectorAll('.mermaid');
                    if (diagrams.length > 0 && diagrams[0].querySelector('svg')) {
                        this.setupDiagrams();
                    } else {
                        setTimeout(checkMermaid, 500);
                    }
                };
                checkMermaid();
            }

            setupDiagrams() {
                document.querySelectorAll('.diagram-container').forEach((container, index) => {
                    this.addZoomControls(container, index);
                    this.setupZoomAndPan(container);
                });
            }

            addZoomControls(container, index) {
                const controls = document.createElement('div');
                controls.className = 'zoom-controls';
                controls.innerHTML = `
                    <button class="zoom-btn" onclick="diagramController.zoomIn(${index})" title="Acercar">+</button>
                    <div class="zoom-level" id="zoom-level-${index}">100%</div>
                    <button class="zoom-btn" onclick="diagramController.zoomOut(${index})" title="Alejar">−</button>
                    <button class="zoom-btn" onclick="diagramController.resetZoom(${index})" title="Resetear">⌂</button>
                    <button class="zoom-btn fullscreen-btn" onclick="diagramController.toggleFullscreen(${index})" title="Pantalla completa">⛶</button>
                `;
                container.appendChild(controls);
            }

            setupZoomAndPan(container) {
                const mermaidDiv = container.querySelector('.mermaid');
                if (!mermaidDiv) return;

                let scale = 1;
                let translateX = 0;
                let translateY = 0;
                let isDragging = false;
                let startX = 0;
                let startY = 0;

                container.dataset.scale = scale;
                container.dataset.translateX = translateX;
                container.dataset.translateY = translateY;

                mermaidDiv.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    scale *= delta;
                    scale = Math.max(0.1, Math.min(5, scale));
                    this.updateTransform(container, scale, translateX, translateY);
                });

                mermaidDiv.addEventListener('mousedown', (e) => {
                    if (scale > 1) {
                        isDragging = true;
                        startX = e.clientX - translateX;
                        startY = e.clientY - translateY;
                        mermaidDiv.style.cursor = 'grabbing';
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        translateX = e.clientX - startX;
                        translateY = e.clientY - startY;
                        this.updateTransform(container, scale, translateX, translateY);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        mermaidDiv.style.cursor = scale > 1 ? 'grab' : 'grab';
                    }
                });
            }

            updateTransform(container, scale, translateX, translateY) {
                const mermaidDiv = container.querySelector('.mermaid');
                const svg = mermaidDiv.querySelector('svg');
                
                if (svg) {
                    svg.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
                    
                    container.dataset.scale = scale;
                    container.dataset.translateX = translateX;
                    container.dataset.translateY = translateY;
                    
                    const index = Array.from(document.querySelectorAll('.diagram-container')).indexOf(container);
                    const zoomLevel = document.getElementById(`zoom-level-${index}`);
                    if (zoomLevel) {
                        zoomLevel.textContent = Math.round(scale * 100) + '%';
                    }
                    
                    mermaidDiv.style.cursor = scale > 1 ? 'grab' : 'grab';
                }
            }

            zoomIn(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                const scale = parseFloat(container.dataset.scale) * 1.2;
                const translateX = parseFloat(container.dataset.translateX);
                const translateY = parseFloat(container.dataset.translateY);
                this.updateTransform(container, Math.min(5, scale), translateX, translateY);
            }

            zoomOut(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                const scale = parseFloat(container.dataset.scale) / 1.2;
                const translateX = parseFloat(container.dataset.translateX);
                const translateY = parseFloat(container.dataset.translateY);
                this.updateTransform(container, Math.max(0.1, scale), translateX, translateY);
            }

            resetZoom(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                this.updateTransform(container, 1, 0, 0);
            }

            toggleFullscreen(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                const mermaidDiv = container.querySelector('.mermaid');
                
                if (document.querySelector('.diagram-fullscreen')) {
                    const fullscreenDiv = document.querySelector('.diagram-fullscreen');
                    const originalMermaid = fullscreenDiv.querySelector('.mermaid');
                    container.appendChild(originalMermaid);
                    document.body.removeChild(fullscreenDiv);
                    document.body.style.overflow = '';
                } else {
                    const fullscreenDiv = document.createElement('div');
                    fullscreenDiv.className = 'diagram-fullscreen';
                    fullscreenDiv.appendChild(mermaidDiv.cloneNode(true));
                    
                    const exitBtn = document.createElement('button');
                    exitBtn.innerHTML = '✕';
                    exitBtn.style.cssText = `
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        cursor: pointer;
                        font-size: 20px;
                        z-index: 10001;
                    `;
                    exitBtn.onclick = () => this.toggleFullscreen(index);
                    fullscreenDiv.appendChild(exitBtn);
                    
                    document.body.appendChild(fullscreenDiv);
                    document.body.style.overflow = 'hidden';
                    
                    this.setupZoomAndPan(fullscreenDiv);
                }
            }
        }

        let diagramController;
        document.addEventListener('DOMContentLoaded', () => {
            diagramController = new DiagramController();
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #27ae60;
            border-bottom: 3px solid #27ae60;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h3 {
            color: #3498db;
            margin-top: 30px;
        }
        .diagram-container {
            margin: 30px 0;
            padding: 20px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            position: relative;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 1px solid #e1e8ed;
        }
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #27ae60;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: #229954;
            transform: scale(1.05);
        }
        .zoom-btn:active {
            transform: scale(0.95);
        }
        .zoom-level {
            font-size: 12px;
            text-align: center;
            color: #666;
            margin: 2px 0;
            font-weight: 500;
        }
        .fullscreen-btn {
            background: #e74c3c;
        }
        .fullscreen-btn:hover {
            background: #c0392b;
        }
        .diagram-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .diagram-fullscreen .mermaid {
            max-width: 95vw;
            max-height: 95vh;
            background: white;
        }
        .description {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
        .mermaid {
            display: flex;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: grab;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: #fafbfc;
        }
        .mermaid:active {
            cursor: grabbing;
        }
        .mermaid svg {
            transition: transform 0.2s ease;
            max-width: none !important;
            max-height: none !important;
        }
        .toc {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        .toc li {
            margin: 8px 0;
        }
        .toc a {
            color: #27ae60;
            text-decoration: none;
            font-weight: 500;
        }
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 Backend Architecture - GPX Application</h1>
        
        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #27ae60;">
            <h3 style="margin: 0 0 10px 0; color: #1e8449;">🎮 Controles Interactivos</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                <div><strong>🔍 Zoom:</strong> Botones +/- o rueda del mouse</div>
                <div><strong>🏠 Reset:</strong> Botón de casa para volver al tamaño original</div>
                <div><strong>🖱️ Arrastrar:</strong> Click y arrastra para mover el diagrama</div>
                <div><strong>🖥️ Pantalla Completa:</strong> Botón rojo para vista ampliada</div>
            </div>
        </div>
        
        <div class="toc">
            <h3>📋 Tabla de Contenidos</h3>
            <ul>
                <li><a href="#architecture">1. Arquitectura General del Backend</a></li>
                <li><a href="#auth-security">2. Autenticación y Seguridad</a></li>
                <li><a href="#data-layer">3. Capa de Datos y Entidades</a></li>
                <li><a href="#api-endpoints">4. APIs y Endpoints</a></li>
                <li><a href="#service-layer">5. Capa de Servicios</a></li>
                <li><a href="#file-management">6. Gestión de Archivos</a></li>
                <li><a href="#error-handling">7. Manejo de Errores</a></li>
                <li><a href="#middleware">8. Middleware y Filtros</a></li>
                <li><a href="#configuration">9. Configuración y Dependencias</a></li>
                <li><a href="#testing">10. Testing y Validaciones</a></li>
            </ul>
        </div>

        <section id="architecture">
            <h2>1. 🏗️ Arquitectura General del Backend</h2>
            <div class="description">
                <strong>Descripción:</strong> Arquitectura de Spring Boot siguiendo el patrón MVC con separación en capas: Controller, Service, Repository y Entity. Incluye configuración de seguridad, manejo de archivos y APIs REST.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph "🚀 Spring Boot Application"
                        subgraph "📁 src/main/java/com/gpx/"
                            subgraph "🎯 controller/ (Presentation Layer)"
                                C1[UserController]
                                C2[EventController]
                                C3[StageController]
                                C4[AuthController]
                                C5[FileController]
                            end
                            
                            subgraph "⚙️ service/ (Business Layer)"
                                S1[UserService]
                                S2[EventService]
                                S3[StageService]
                                S4[AuthService]
                                S5[FileStorageService]
                                S6[EmailService]
                            end
                            
                            subgraph "🗄️ repository/ (Data Layer)"
                                R1[UserRepository]
                                R2[EventRepository]
                                R3[StageRepository]
                                R4[CategoryRepository]
                                R5[VehicleRepository]
                            end
                            
                            subgraph "📊 entity/ (Domain Models)"
                                E1[User]
                                E2[Event]
                                E3[Stage]
                                E4[Category]
                                E5[Vehicle]
                                E6[UserVehicle]
                            end
                            
                            subgraph "🔐 config/ (Configuration)"
                                CF1[SecurityConfig]
                                CF2[WebConfig]
                                CF3[JwtConfig]
                                CF4[OAuth2Config]
                                CF5[FileConfig]
                            end
                            
                            subgraph "🛡️ security/"
                                SEC1[JwtTokenProvider]
                                SEC2[JwtAuthenticationFilter]
                                SEC3[OAuth2AuthenticationHandler]
                                SEC4[CustomUserDetailsService]
                            end
                            
                            subgraph "📝 dto/ (Data Transfer Objects)"
                                D1[UserDTO]
                                D2[EventDTO]
                                D3[LoginRequest]
                                D4[ApiResponse]
                            end
                            
                            subgraph "⚠️ exception/"
                                EX1[GlobalExceptionHandler]
                                EX2[CustomExceptions]
                                EX3[ApiError]
                            end
                        end
                    end
                    
                    subgraph "🗃️ External Dependencies"
                        DB[(MySQL Database)]
                        GOOGLE[Google OAuth2]
                        FILES[File System]
                        MAIL[Email Server]
                    end
                    
                    C1 --> S1
                    C2 --> S2
                    C3 --> S3
                    C4 --> S4
                    C5 --> S5
                    
                    S1 --> R1
                    S2 --> R2
                    S3 --> R3
                    S5 --> FILES
                    S6 --> MAIL
                    
                    R1 --> E1
                    R2 --> E2
                    R3 --> E3
                    R4 --> E4
                    R5 --> E5
                    
                    R1 --> DB
                    R2 --> DB
                    R3 --> DB
                    R4 --> DB
                    R5 --> DB
                    
                    SEC1 --> CF3
                    SEC2 --> SEC1
                    SEC3 --> GOOGLE
                    
                    C1 --> D1
                    C2 --> D2
                    C4 --> D3
                    
                    EX1 --> EX3
                    C1 --> EX1
                    C2 --> EX1
                    C3 --> EX1
                    C4 --> EX1
                </div>
            </div>
        </section>

        <section id="auth-security">
            <h2>2. 🔐 Autenticación y Seguridad</h2>
            <div class="description">
                <strong>Descripción:</strong> Sistema completo de autenticación con JWT y OAuth2 (Google). Incluye filtros de seguridad, generación de tokens, validación de permisos y manejo de sesiones.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    START([Cliente inicia solicitud]) --> AUTH_CHECK{¿Requiere autenticación?}
                    
                    AUTH_CHECK -->|No| ALLOW[Permitir acceso]
                    AUTH_CHECK -->|Sí| TOKEN_CHECK{¿Tiene token JWT?}
                    
                    TOKEN_CHECK -->|No| LOGIN_OPTIONS{Tipo de login}
                    TOKEN_CHECK -->|Sí| VALIDATE_TOKEN[JwtAuthenticationFilter<br/>Validar token]
                    
                    LOGIN_OPTIONS -->|Local| LOCAL_LOGIN[AuthController.login<br/>Validar credenciales]
                    LOGIN_OPTIONS -->|Google OAuth2| OAUTH_FLOW[OAuth2AuthenticationHandler<br/>Flujo Google]
                    
                    LOCAL_LOGIN --> CHECK_CREDS{¿Credenciales válidas?}
                    CHECK_CREDS -->|No| ERROR_401[Error 401 Unauthorized]
                    CHECK_CREDS -->|Sí| GENERATE_JWT[JwtTokenProvider<br/>Generar token JWT]
                    
                    OAUTH_FLOW --> GOOGLE_AUTH[Autenticación con Google]
                    GOOGLE_AUTH --> OAUTH_SUCCESS{¿Éxito OAuth2?}
                    OAUTH_SUCCESS -->|No| ERROR_401
                    OAUTH_SUCCESS -->|Sí| CREATE_OR_UPDATE[Crear/actualizar usuario]
                    CREATE_OR_UPDATE --> GENERATE_JWT
                    
                    VALIDATE_TOKEN --> TOKEN_VALID{¿Token válido?}
                    TOKEN_VALID -->|No| ERROR_401
                    TOKEN_VALID -->|Sí| EXTRACT_USER[Extraer información del usuario]
                    
                    EXTRACT_USER --> CHECK_PERMISSIONS{¿Tiene permisos?}
                    CHECK_PERMISSIONS -->|No| ERROR_403[Error 403 Forbidden]
                    CHECK_PERMISSIONS -->|Sí| ALLOW
                    
                    GENERATE_JWT --> RETURN_TOKEN[Retornar token al cliente]
                    RETURN_TOKEN --> ALLOW
                    
                    subgraph "🔧 Componentes de Seguridad"
                        JWT_PROVIDER[JwtTokenProvider<br/>- generateToken<br/>- validateToken<br/>- extractUsername]
                        JWT_FILTER[JwtAuthenticationFilter<br/>- doFilterInternal<br/>- validateTokenHeader]
                        USER_DETAILS[CustomUserDetailsService<br/>- loadUserByUsername<br/>- mapToUserDetails]
                        SECURITY_CONFIG[SecurityConfig<br/>- filterChain<br/>- authenticationManager]
                    end
                    
                    subgraph "📊 Flujo de Datos"
                        TOKEN_STRUCTURE[Token JWT Structure:<br/>Header: alg, typ<br/>Payload: sub, iat, exp, authorities<br/>Signature: HMAC SHA256]
                        USER_CONTEXT[SecurityContext:<br/>Authentication object<br/>Principal: User details<br/>Authorities: Roles/Permissions]
                    end
                </div>
            </div>
        </section>

        <section id="data-layer">
            <h2>3. 🗄️ Capa de Datos y Entidades</h2>
            <div class="description">
                <strong>Descripción:</strong> Modelo de datos con entidades JPA, relaciones entre tablas y repositorios para acceso a datos. Incluye todas las entidades del sistema y sus interrelaciones.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                erDiagram
                    USER {
                        Long id PK
                        String username UK
                        String email UK
                        String password
                        String fullName
                        String phone
                        String identification
                        String emergencyContact
                        String bloodType
                        String allergies
                        String medications
                        String instagram
                        String facebook
                        String team
                        String authProvider
                        Boolean isAdmin
                        LocalDateTime createdAt
                        LocalDateTime updatedAt
                    }
                    
                    EVENT {
                        Long id PK
                        String name
                        String description
                        String location
                        LocalDateTime startDate
                        LocalDateTime endDate
                        String pictureUrl
                        Boolean isActive
                        LocalDateTime createdAt
                        LocalDateTime updatedAt
                    }
                    
                    STAGE {
                        Long id PK
                        String name
                        String description
                        String location
                        LocalDateTime startTime
                        LocalDateTime endTime
                        Boolean isNeutralized
                        Long eventId FK
                        LocalDateTime createdAt
                        LocalDateTime updatedAt
                    }
                    
                    CATEGORY {
                        Long id PK
                        String name
                        String description
                        String color
                        Boolean isActive
                        LocalDateTime createdAt
                        LocalDateTime updatedAt
                    }
                    
                    VEHICLE {
                        Long id PK
                        String brand
                        String model
                        String year
                        String color
                        String licensePlate
                        String type
                        LocalDateTime createdAt
                        LocalDateTime updatedAt
                    }
                    
                    USER_VEHICLE {
                        Long id PK
                        Long userId FK
                        Long vehicleId FK
                        Boolean isPrimary
                        LocalDateTime assignedAt
                    }
                    
                    EVENT_CATEGORY {
                        Long eventId FK
                        Long categoryId FK
                    }
                    
                    USER ||--o{ USER_VEHICLE : "owns"
                    VEHICLE ||--o{ USER_VEHICLE : "owned_by"
                    EVENT ||--o{ STAGE : "contains"
                    EVENT ||--o{ EVENT_CATEGORY : "has"
                    CATEGORY ||--o{ EVENT_CATEGORY : "belongs_to"
                </div>
            </div>
        </section>

        <section id="api-endpoints">
            <h2>4. 🌐 APIs y Endpoints</h2>
            <div class="description">
                <strong>Descripción:</strong> Mapeo completo de todos los endpoints REST del sistema, organizados por controlador, con métodos HTTP, rutas y funcionalidades.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph API_ENDPOINTS["API Endpoints"]
                        subgraph USERS_API["api users - UserController"]
                            U1[GET raiz - Obtener todos los usuarios - Requiere ADMIN]
                            U2[GET por id - Obtener usuario por ID - Requiere AUTH]
                            U3[PUT por id - Actualizar usuario - Requiere OWNER ADMIN]
                            U4[DELETE por id - Eliminar usuario - Requiere ADMIN]
                            U5[GET profile - Obtener perfil actual - Requiere AUTH]
                            U6[PUT profile - Actualizar perfil - Requiere AUTH]
                            U7[PUT change password - Cambiar contrasena - Requiere AUTH]
                        end
                        
                        subgraph EVENTS_API["api events - EventController"]
                            E1[GET raiz - Obtener todos los eventos - Publico]
                            E2[GET por id - Obtener evento por ID - Publico]
                            E3[POST raiz - Crear evento - Requiere ADMIN]
                            E4[PUT por id - Actualizar evento - Requiere ADMIN]
                            E5[DELETE por id - Eliminar evento - Requiere ADMIN]
                            E6[PUT picture - Subir imagen - Requiere ADMIN]
                            E7[DELETE picture - Eliminar imagen - Requiere ADMIN]
                            E8[GET stages - Obtener etapas - Publico]
                        end
                        
                        subgraph STAGES_API["api stages - StageController"]
                            S1[GET raiz - Obtener todas las etapas - Publico]
                            S2[GET por id - Obtener etapa por ID - Publico]
                            S3[POST raiz - Crear etapa - Requiere ADMIN]
                            S4[PUT por id - Actualizar etapa - Requiere ADMIN]
                            S5[DELETE por id - Eliminar etapa - Requiere ADMIN]
                            S6[PUT neutralize - Neutralizar etapa - Requiere ADMIN]
                        end
                        
                        subgraph AUTH_API["api auth - AuthController"]
                            A1[POST login - Autenticacion local - Publico]
                            A2[POST register - Registro de usuario - Publico]
                            A3[GET oauth2 google - Iniciar OAuth2 - Publico]
                            A4[POST refresh - Renovar token - Requiere REFRESH TOKEN]
                            A5[POST logout - Cerrar sesion - Requiere AUTH]
                        end
                        
                        subgraph VEHICLES_API["api vehicles - VehicleController"]
                            V1[GET raiz - Obtener vehiculos del usuario - Requiere AUTH]
                            V2[POST raiz - Crear vehiculo - Requiere AUTH]
                            V3[PUT por id - Actualizar vehiculo - Requiere OWNER]
                            V4[DELETE por id - Eliminar vehiculo - Requiere OWNER]
                            V5[PUT primary - Marcar como principal - Requiere OWNER]
                        end
                        
                        subgraph FILES_API["api files - FileController"]
                            F1[POST upload - Subir archivo - Requiere AUTH]
                            F2[GET filename - Descargar archivo - Publico]
                            F3[DELETE filename - Eliminar archivo - Requiere ADMIN]
                        end
                        
                        subgraph CATEGORIES_API["api categories - CategoryController"]
                            C1[GET raiz - Obtener categorias - Publico]
                            C2[POST raiz - Crear categoria - Requiere ADMIN]
                            C3[PUT por id - Actualizar categoria - Requiere ADMIN]
                            C4[DELETE por id - Eliminar categoria - Requiere ADMIN]
                        end
                    end
                    
                    subgraph HTTP_CODES["Codigos de Respuesta HTTP"]
                        HTTP1[200 OK - Operacion exitosa]
                        HTTP2[201 Created - Recurso creado]
                        HTTP3[400 Bad Request - Datos invalidos]
                        HTTP4[401 Unauthorized - No autenticado]
                        HTTP5[403 Forbidden - Sin permisos]
                        HTTP6[404 Not Found - Recurso no encontrado]
                        HTTP7[500 Internal Server Error - Error servidor]
                    end
                </div>
            </div>
        </section>

        <section id="service-layer">
            <h2>5. ⚙️ Capa de Servicios</h2>
            <div class="description">
                <strong>Descripción:</strong> Lógica de negocio implementada en los servicios, mostrando las interacciones entre servicios, validaciones y procesamiento de datos.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TD
                    subgraph "⚙️ Service Layer Architecture"
                        subgraph "👥 UserService"
                            US1[getAllUsers]
                            US2[getUserById]
                            US3[updateUser]
                            US4[deleteUser]
                            US5[getUserProfile]
                            US6[updateProfile]
                            US7[changePassword]
                            US8[validateUserPermissions]
                        end
                        
                        subgraph "🎪 EventService"
                            ES1[getAllEvents]
                            ES2[getEventById]
                            ES3[createEvent]
                            ES4[updateEvent]
                            ES5[deleteEvent]
                            ES6[updateEventPicture]
                            ES7[removeEventPicture]
                            ES8[getEventStages]
                            ES9[validateEventDates]
                        end
                        
                        subgraph "🏁 StageService"
                            SS1[getAllStages]
                            SS2[getStageById]
                            SS3[createStage]
                            SS4[updateStage]
                            SS5[deleteStage]
                            SS6[neutralizeStage]
                            SS7[validateStageOverlap]
                            SS8[getStagesByEvent]
                        end
                        
                        subgraph "🔑 AuthService"
                            AS1[authenticateUser]
                            AS2[registerUser]
                            AS3[processOAuth2Login]
                            AS4[generateTokens]
                            AS5[refreshToken]
                            AS6[revokeToken]
                            AS7[validatePassword]
                            AS8[encryptPassword]
                        end
                        
                        subgraph "📁 FileStorageService"
                            FS1[uploadFile]
                            FS2[downloadFile]
                            FS3[deleteFile]
                            FS4[validateFileType]
                            FS5[validateFileSize]
                            FS6[generateUniqueFileName]
                            FS7[getFileUrl]
                            FS8[cleanupOrphanFiles]
                        end
                        
                        subgraph "🚗 VehicleService"
                            VS1[getUserVehicles]
                            VS2[createVehicle]
                            VS3[updateVehicle]
                            VS4[deleteVehicle]
                            VS5[setPrimaryVehicle]
                            VS6[validateLicensePlate]
                            VS7[checkVehicleOwnership]
                        end
                    end
                    
                    subgraph "🔗 Service Interactions"
                        ES3 --> FS4
                        ES6 --> FS1
                        ES7 --> FS3
                        
                        AS2 --> US8
                        AS3 --> US2
                        
                        SS3 --> ES2
                        SS7 --> ES8
                        
                        VS2 --> US2
                        VS7 --> US8
                        
                        FS8 --> ES1
                        FS8 --> US1
                    end
                    
                    subgraph "🛡️ Validations & Business Rules"
                        V1[Password Policy:<br/>Min 8 chars, Special chars]
                        V2[File Validation:<br/>Max 5MB, Allowed types]
                        V3[Date Validation:<br/>Start < End, No overlap]
                        V4[User Permissions:<br/>Admin, Owner checks]
                        V5[Email Validation:<br/>Unique, Valid format]
                        V6[License Plate:<br/>Valid format, Unique]
                    end
                </div>
            </div>
        </section>

        </section>

        <section id="file-management">
            <h2>6. 📁 Gestión de Archivos</h2>
            <div class="description">
                <strong>Descripción:</strong> Sistema completo de manejo de archivos con validaciones, almacenamiento local, generación de URLs y limpieza automática de archivos huérfanos.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    START([Cliente solicita subir archivo]) --> VALIDATE_AUTH{Usuario autenticado}
                    
                    VALIDATE_AUTH -->|No| ERROR_401[Error 401 No autorizado]
                    VALIDATE_AUTH -->|Si| RECEIVE_FILE[FileController uploadFile - Recibir MultipartFile]
                    
                    RECEIVE_FILE --> VALIDATE_FILE{FileStorageService - Validar archivo}
                    
                    VALIDATE_FILE --> CHECK_TYPE{Tipo permitido}
                    CHECK_TYPE -->|No| ERROR_TYPE[Error 400 Tipo no permitido - Permitidos jpg png pdf doc]
                    CHECK_TYPE -->|Si| CHECK_SIZE{Tamano correcto}
                    
                    CHECK_SIZE -->|No| ERROR_SIZE[Error 400 Archivo muy grande - Maximo 5MB]
                    CHECK_SIZE -->|Si| GENERATE_NAME[Generar nombre unico - UUID timestamp extension]
                    
                    GENERATE_NAME --> CREATE_PATH[Crear ruta de almacenamiento - uploads category filename]
                    CREATE_PATH --> SAVE_FILE[Guardar archivo en disco]
                    
                    SAVE_FILE --> SUCCESS{Guardado exitoso}
                    SUCCESS -->|No| ERROR_SAVE[Error 500 Error al guardar]
                    SUCCESS -->|Si| GENERATE_URL[Generar URL de acceso - api files filename]
                    
                    GENERATE_URL --> UPDATE_ENTITY[Actualizar entidad - pictureUrl en Event User]
                    UPDATE_ENTITY --> CLEANUP[Eliminar archivo anterior - si existia]
                    CLEANUP --> RETURN_SUCCESS[Retornar URL y metadata]
                    
                    subgraph FILE_STRUCTURE["Estructura de Archivos"]
                        STRUCTURE[uploads - events event1 jpg event2 png - users avatar1 jpg avatar2 png - temp temp files]
                    end
                    
                    subgraph VALIDATIONS["Validaciones"]
                        VAL1[Tipos permitidos - Imagenes jpg jpeg png gif - Documentos pdf doc docx - Tamano maximo 5MB - Nombre seguro sin caracteres especiales]
                        
                        VAL2[Seguridad - Verificar extension real - Escanear contenido - Limitar acceso por usuario - Limpiar metadatos EXIF]
                    end
                    
                    subgraph CLEANUP_PROCESS["Cleanup Process"]
                        CLEANUP_START[Tarea programada Scheduled cada 24h]
                        CLEANUP_START --> FIND_ORPHANS[Buscar archivos huerfanos - Sin referencia en BD]
                        FIND_ORPHANS --> DELETE_ORPHANS[Eliminar archivos - mas antiguos que 7 dias]
                        DELETE_ORPHANS --> LOG_CLEANUP[Log de limpieza]
                    end
                </div>
            </div>
        </section>

        <section id="error-handling">
            <h2>7. ⚠️ Manejo de Errores</h2>
            <div class="description">
                <strong>Descripción:</strong> Sistema centralizado de manejo de excepciones con GlobalExceptionHandler, respuestas estandarizadas y logging comprehensivo.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TD
                    EXCEPTION([Excepcion ocurre]) --> EXCEPTION_TYPE{Tipo de excepcion}
                    
                    EXCEPTION_TYPE -->|ValidationException| VALIDATION_HANDLER[GlobalExceptionHandler - handleValidationException]
                    EXCEPTION_TYPE -->|ResourceNotFoundException| NOT_FOUND_HANDLER[GlobalExceptionHandler - handleResourceNotFound]
                    EXCEPTION_TYPE -->|UnauthorizedException| UNAUTHORIZED_HANDLER[GlobalExceptionHandler - handleUnauthorized]
                    EXCEPTION_TYPE -->|ForbiddenException| FORBIDDEN_HANDLER[GlobalExceptionHandler - handleForbidden]
                    EXCEPTION_TYPE -->|FileStorageException| FILE_HANDLER[GlobalExceptionHandler - handleFileStorageException]
                    EXCEPTION_TYPE -->|DataIntegrityViolationException| INTEGRITY_HANDLER[GlobalExceptionHandler - handleDataIntegrity]
                    EXCEPTION_TYPE -->|Exception| GENERIC_HANDLER[GlobalExceptionHandler - handleGenericException]
                    
                    VALIDATION_HANDLER --> BUILD_RESPONSE_400[Construir ApiError - Status 400 Bad Request]
                    NOT_FOUND_HANDLER --> BUILD_RESPONSE_404[Construir ApiError - Status 404 Not Found]
                    UNAUTHORIZED_HANDLER --> BUILD_RESPONSE_401[Construir ApiError - Status 401 Unauthorized]
                    FORBIDDEN_HANDLER --> BUILD_RESPONSE_403[Construir ApiError - Status 403 Forbidden]
                    FILE_HANDLER --> BUILD_RESPONSE_422[Construir ApiError - Status 422 Unprocessable Entity]
                    INTEGRITY_HANDLER --> BUILD_RESPONSE_409[Construir ApiError - Status 409 Conflict]
                    GENERIC_HANDLER --> BUILD_RESPONSE_500[Construir ApiError - Status 500 Internal Server Error]
                    
                    BUILD_RESPONSE_400 --> LOG_ERROR[Logging con nivel apropiado]
                    BUILD_RESPONSE_404 --> LOG_ERROR
                    BUILD_RESPONSE_401 --> LOG_ERROR
                    BUILD_RESPONSE_403 --> LOG_ERROR
                    BUILD_RESPONSE_422 --> LOG_ERROR
                    BUILD_RESPONSE_409 --> LOG_ERROR
                    BUILD_RESPONSE_500 --> LOG_ERROR
                    
                    LOG_ERROR --> RETURN_RESPONSE[Retornar ResponseEntity ApiError]
                    
                    subgraph API_ERROR_STRUCTURE["Estructura ApiError"]
                        API_ERROR[ApiError - timestamp LocalDateTime - status int - error String - message String - path String - details Map String Object - traceId String]
                    end
                    
                    subgraph CUSTOM_ERRORS["Tipos de Errores Customizados"]
                        CUSTOM_EX1[ResourceNotFoundException - Usuario no encontrado - Evento no encontrado - Etapa no encontrada]
                        
                        CUSTOM_EX2[ValidationException - Datos invalidos - Formato incorrecto - Campos requeridos]
                        
                        CUSTOM_EX3[UnauthorizedException - Token invalido - Token expirado - Credenciales incorrectas]
                        
                        CUSTOM_EX4[ForbiddenException - Sin permisos de admin - Acceso a recurso ajeno - Operacion no permitida]
                        
                        CUSTOM_EX5[FileStorageException - Error al subir archivo - Archivo no encontrado - Tipo no permitido]
                    end
                    
                    subgraph LOGGING_SYSTEM["Sistema de Logging"]
                        LOG_CONFIG[Configuracion Logback - INFO Operaciones normales - WARN Errores recuperables - ERROR Errores criticos - DEBUG Informacion detallada]
                        
                        LOG_LEVELS[Niveles por package - root INFO - com gpx DEBUG - org springframework security DEBUG - org hibernate WARN]
                    end
                </div>
            </div>
        </section>

        <section id="middleware">
            <h2>8. 🔧 Middleware y Filtros</h2>
            <div class="description">
                <strong>Descripción:</strong> Cadena de filtros de Spring Security, interceptores HTTP y middleware personalizado para logging, CORS y validación de tokens.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    REQUEST([HTTP Request]) --> CORS_FILTER[CorsFilter - Validar origen y metodos]
                    
                    CORS_FILTER --> SECURITY_CONTEXT[SecurityContextPersistenceFilter - Inicializar SecurityContext]
                    
                    SECURITY_CONTEXT --> JWT_FILTER[JwtAuthenticationFilter - Procesar token JWT]
                    
                    JWT_FILTER --> HAS_TOKEN{Tiene token JWT}
                    
                    HAS_TOKEN -->|No| ANONYMOUS_AUTH[AnonymousAuthenticationFilter - Crear autenticacion anonima]
                    HAS_TOKEN -->|Si| VALIDATE_TOKEN[Validar token JWT]
                    
                    VALIDATE_TOKEN --> TOKEN_VALID{Token valido}
                    TOKEN_VALID -->|No| AUTH_ENTRY_POINT[AuthenticationEntryPoint - Retornar 401]
                    TOKEN_VALID -->|Si| SET_AUTH[Establecer Authentication - en SecurityContext]
                    
                    ANONYMOUS_AUTH --> AUTHORIZATION_FILTER[AuthorizationFilter - Verificar permisos]
                    SET_AUTH --> AUTHORIZATION_FILTER
                    
                    AUTHORIZATION_FILTER --> HAS_PERMISSION{Tiene permisos}
                    HAS_PERMISSION -->|No| ACCESS_DENIED[AccessDeniedHandler - Retornar 403]
                    HAS_PERMISSION -->|Si| CONTROLLER[Llegar al Controller]
                    
                    CONTROLLER --> RESPONSE[HTTP Response]
                    AUTH_ENTRY_POINT --> RESPONSE
                    ACCESS_DENIED --> RESPONSE
                    
                    subgraph SECURITY_FILTER_CHAIN["Security Filter Chain"]
                        FILTER_ORDER[Orden de filtros - 1 CorsFilter - 2 SecurityContextPersistenceFilter - 3 JwtAuthenticationFilter - 4 AnonymousAuthenticationFilter - 5 AuthorizationFilter - 6 ExceptionTranslationFilter]
                    end
                    
                    subgraph JWT_TOKEN_PROCESSING["JWT Token Processing"]
                        JWT_EXTRACT[Extraer de header - Authorization Bearer token]
                        JWT_VALIDATE[Validar - Firma HMAC - Fecha expiracion - Estructura correcta]
                        JWT_PARSE[Extraer claims - username subject - authorities roles - issued at - expiration]
                    end
                    
                    subgraph CORS_CONFIGURATION["CORS Configuration"]
                        CORS_CONFIG[Configuracion CORS - Origenes permitidos localhost 3000 - Metodos GET POST PUT DELETE - Headers Authorization Content Type - Credentials true]
                    end
                    
                    subgraph REQUEST_LOGGING["Request Logging"]
                        LOG_REQUEST[LoggingInterceptor - URL y metodo HTTP - Headers importantes - IP del cliente - Timestamp - ID de sesion]
                        
                        LOG_RESPONSE[Response Logging - Status code - Tiempo de procesamiento - Tamano de respuesta - Errores si los hay]
                    end
                    
                    subgraph PERFORMANCE_MONITORING["Performance Monitoring"]
                        METRICS[Metricas recolectadas - Tiempo de respuesta promedio - Numero de requests por endpoint - Errores por minuto - Uso de memoria]
                    end
                </div>
            </div>
        </section>

        <section id="configuration">
            <h2>9. ⚙️ Configuración y Dependencias</h2>
            <div class="description">
                <strong>Descripción:</strong> Configuración de Spring Boot, dependencias Maven, propiedades de aplicación y configuración de entornos (dev, prod).
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph MAVEN_DEPENDENCIES["Maven Dependencies pom xml"]
                        SPRING_BOOT[spring boot starter web - spring boot starter data jpa - spring boot starter security - spring boot starter oauth2 client]
                        
                        DATABASE[mysql connector java - spring boot starter data jpa - hibernate core]
                        
                        SECURITY_DEPS[spring security jwt - jjwt api - jjwt impl - jjwt jackson]
                        
                        UTILITIES[spring boot starter validation - spring boot starter mail - commons io - apache commons lang3]
                        
                        TESTING[spring boot starter test - spring security test - testcontainers mysql - junit jupiter]
                    end
                    
                    subgraph CONFIGURATION_CLASSES["Configuration Classes"]
                        SEC_CONFIG[SecurityConfig - Configuration - EnableWebSecurity - filterChain - passwordEncoder - authenticationManager]
                        
                        WEB_CONFIG[WebConfig - Configuration - EnableWebMvc - addCorsMappings - addResourceHandlers - configureMessageConverters]
                        
                        JWT_CONFIG[JwtConfig - Configuration - ConfigurationProperties - secret - expiration - refreshExpiration]
                        
                        OAUTH_CONFIG[OAuth2Config - Configuration - clientRegistrations - successHandler - failureHandler]
                        
                        FILE_CONFIG[FileStorageConfig - Configuration - uploadDir - maxFileSize - allowedTypes]
                    end
                    
                    subgraph APPLICATION_PROPERTIES["Application Properties"]
                        APP_PROPS[application yml - server port 8080 - spring datasource url jdbc mysql localhost 3306 gpx - username DB USER - password DB PASSWORD - jpa hibernate ddl auto update]
                        
                        JWT_PROPS[JWT Configuration - app jwt secret JWT SECRET - expiration 86400 - refresh expiration 604800]
                        
                        OAUTH_PROPS[OAuth2 Configuration - spring security oauth2 client registration google - client id GOOGLE CLIENT ID - client secret GOOGLE CLIENT SECRET]
                        
                        FILE_PROPS[File Upload Configuration - app file upload dir uploads - max file size 5MB - allowed types jpg png pdf doc]
                    end
                    
                    subgraph ENVIRONMENT_PROFILES["Environment Profiles"]
                        DEV_PROFILE[application dev yml - H2 in memory database - Debug logging - Hot reload enabled - Relaxed CORS]
                        
                        PROD_PROFILE[application prod yml - MySQL production DB - Error logging only - Security hardening - Optimized JVM]
                        
                        TEST_PROFILE[application test yml - TestContainers MySQL - Mock external services - Fast test execution - Isolated test data]
                    end
                    
                    subgraph ENVIRONMENT_VARIABLES["Environment Variables"]
                        ENV_VARS[Required Variables - DB USER Database username - DB PASSWORD Database password - JWT SECRET JWT signing key - GOOGLE CLIENT ID OAuth2 client - GOOGLE CLIENT SECRET OAuth2 secret - UPLOAD DIR File storage path]
                    end
                </div>
            </div>
        </section>

        <section id="testing">
            <h2>10. 🧪 Testing y Validaciones</h2>
            <div class="description">
                <strong>Descripción:</strong> Estrategia de testing con tests unitarios, de integración y validaciones de datos usando Bean Validation (JSR-303).
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph TESTING_STRATEGY["Testing Strategy"]
                        subgraph UNIT_TESTS["Unit Tests"]
                            UT1[ServiceTests - ExtendWith MockitoExtension - Mock dependencies - Test business logic - Verify interactions]
                            
                            UT2[RepositoryTests - DataJpaTest - Test custom queries - Verify relationships - Test constraints]
                            
                            UT3[UtilityTests - Test - JWT token generation - Password encryption - File validation]
                        end
                        
                        subgraph INTEGRATION_TESTS["Integration Tests"]
                            IT1[ControllerTests - SpringBootTest - AutoConfigureTestDatabase - Full Spring context - Real HTTP requests - End to end flow]
                            
                            IT2[SecurityTests - SpringBootTest - WithMockUser - Authentication flow - Authorization checks - JWT validation]
                            
                            IT3[DatabaseTests - Testcontainers - Real MySQL instance - Migration scripts - Data integrity]
                        end
                        
                        subgraph TEST_UTILITIES["Test Utilities"]
                            TU1[TestDataBuilder - User factory - Event factory - Stage factory - Test fixtures]
                            
                            TU2[MockMvcHelpers - Common requests - JSON helpers - Auth utilities]
                            
                            TU3[AssertionHelpers - Custom matchers - JSON assertions - Error validations]
                        end
                    end
                    
                    subgraph BEAN_VALIDATION["Bean Validation JSR 303"]
                        subgraph USER_VALIDATIONS["User Validations"]
                            UV1[NotBlank username email - Email email format - Size password min 8 chars - Pattern phone format - Past birthDate]
                        end
                        
                        subgraph EVENT_VALIDATIONS["Event Validations"]
                            EV1[NotBlank name location - NotNull startDate endDate - Future startDate - AssertTrue endDate after startDate - URL pictureUrl]
                        end
                        
                        subgraph STAGE_VALIDATIONS["Stage Validations"]
                            SV1[NotBlank name - NotNull startTime endTime - AssertTrue endTime after startTime - Valid event reference]
                        end
                        
                        subgraph VEHICLE_VALIDATIONS["Vehicle Validations"]
                            VV1[NotBlank brand model - Pattern licensePlate format - Min Max year range - Enumerated vehicle type]
                        end
                    end
                    
                    subgraph VALIDATION_FLOW["Validation Flow"]
                        REQUEST[HTTP Request] --> CONTROLLER_VALIDATION[Valid annotation triggers validation]
                        CONTROLLER_VALIDATION --> VALIDATION_ERRORS{Validation errors}
                        VALIDATION_ERRORS -->|Yes| METHOD_ARG_EXCEPTION[MethodArgumentNotValidException]
                        VALIDATION_ERRORS -->|No| PROCESS_REQUEST[Process request normally]
                        METHOD_ARG_EXCEPTION --> GLOBAL_HANDLER[GlobalExceptionHandler Return 400 with details]
                    end
                    
                    subgraph TEST_COVERAGE_QUALITY["Test Coverage and Quality"]
                        COVERAGE[JaCoCo Coverage - Line coverage greater than 80 percent - Branch coverage greater than 70 percent - Method coverage greater than 90 percent - Class coverage greater than 85 percent]
                        
                        QUALITY[SonarQube Analysis - Code smells detection - Security vulnerabilities - Duplicated code - Maintainability rating]
                        
                        CI_CD[CI CD Pipeline - Run tests on push - Coverage reports - Quality gates - Deployment on success]
                    end
                </div>
            </div>
        </section>

        <script>
            mermaid.initialize({
                startOnLoad: true,
                theme: 'default',
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                er: {
                    useMaxWidth: true
                }
            });
        </script>
    </div>
</body>
</html> 