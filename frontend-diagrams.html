<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Architecture - GPX Application</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        // Sistema de Zoom y Pan para Diagramas
        class DiagramController {
            constructor() {
                this.initializeAfterMermaid();
            }

            initializeAfterMermaid() {
                // Esperar a que mermaid esté listo
                const checkMermaid = () => {
                    const diagrams = document.querySelectorAll('.mermaid');
                    if (diagrams.length > 0 && diagrams[0].querySelector('svg')) {
                        this.setupDiagrams();
                    } else {
                        setTimeout(checkMermaid, 500);
                    }
                };
                checkMermaid();
            }

            setupDiagrams() {
                document.querySelectorAll('.diagram-container').forEach((container, index) => {
                    this.addZoomControls(container, index);
                    this.setupZoomAndPan(container);
                });
            }

            addZoomControls(container, index) {
                const controls = document.createElement('div');
                controls.className = 'zoom-controls';
                controls.innerHTML = `
                    <button class="zoom-btn" onclick="diagramController.zoomIn(${index})" title="Acercar">+</button>
                    <div class="zoom-level" id="zoom-level-${index}">100%</div>
                    <button class="zoom-btn" onclick="diagramController.zoomOut(${index})" title="Alejar">−</button>
                    <button class="zoom-btn" onclick="diagramController.resetZoom(${index})" title="Resetear">⌂</button>
                    <button class="zoom-btn fullscreen-btn" onclick="diagramController.toggleFullscreen(${index})" title="Pantalla completa">⛶</button>
                `;
                container.appendChild(controls);
            }

            setupZoomAndPan(container) {
                const mermaidDiv = container.querySelector('.mermaid');
                if (!mermaidDiv) return;

                let scale = 1;
                let translateX = 0;
                let translateY = 0;
                let isDragging = false;
                let startX = 0;
                let startY = 0;

                // Guardar estado inicial
                container.dataset.scale = scale;
                container.dataset.translateX = translateX;
                container.dataset.translateY = translateY;

                // Zoom con rueda del mouse
                mermaidDiv.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const rect = mermaidDiv.getBoundingClientRect();
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    scale *= delta;
                    scale = Math.max(0.1, Math.min(5, scale));
                    
                    this.updateTransform(container, scale, translateX, translateY);
                });

                // Pan con arrastre
                mermaidDiv.addEventListener('mousedown', (e) => {
                    if (scale > 1) {
                        isDragging = true;
                        startX = e.clientX - translateX;
                        startY = e.clientY - translateY;
                        mermaidDiv.style.cursor = 'grabbing';
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        translateX = e.clientX - startX;
                        translateY = e.clientY - startY;
                        this.updateTransform(container, scale, translateX, translateY);
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        mermaidDiv.style.cursor = scale > 1 ? 'grab' : 'grab';
                    }
                });
            }

            updateTransform(container, scale, translateX, translateY) {
                const mermaidDiv = container.querySelector('.mermaid');
                const svg = mermaidDiv.querySelector('svg');
                
                if (svg) {
                    svg.style.transform = `scale(${scale}) translate(${translateX / scale}px, ${translateY / scale}px)`;
                    
                    // Actualizar estado
                    container.dataset.scale = scale;
                    container.dataset.translateX = translateX;
                    container.dataset.translateY = translateY;
                    
                    // Actualizar indicador de zoom
                    const index = Array.from(document.querySelectorAll('.diagram-container')).indexOf(container);
                    const zoomLevel = document.getElementById(`zoom-level-${index}`);
                    if (zoomLevel) {
                        zoomLevel.textContent = Math.round(scale * 100) + '%';
                    }
                    
                    // Actualizar cursor
                    mermaidDiv.style.cursor = scale > 1 ? 'grab' : 'grab';
                }
            }

            zoomIn(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                const scale = parseFloat(container.dataset.scale) * 1.2;
                const translateX = parseFloat(container.dataset.translateX);
                const translateY = parseFloat(container.dataset.translateY);
                this.updateTransform(container, Math.min(5, scale), translateX, translateY);
            }

            zoomOut(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                const scale = parseFloat(container.dataset.scale) / 1.2;
                const translateX = parseFloat(container.dataset.translateX);
                const translateY = parseFloat(container.dataset.translateY);
                this.updateTransform(container, Math.max(0.1, scale), translateX, translateY);
            }

            resetZoom(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                this.updateTransform(container, 1, 0, 0);
            }

            toggleFullscreen(index) {
                const container = document.querySelectorAll('.diagram-container')[index];
                const mermaidDiv = container.querySelector('.mermaid');
                
                if (document.querySelector('.diagram-fullscreen')) {
                    // Salir de pantalla completa
                    const fullscreenDiv = document.querySelector('.diagram-fullscreen');
                    const originalMermaid = fullscreenDiv.querySelector('.mermaid');
                    container.appendChild(originalMermaid);
                    document.body.removeChild(fullscreenDiv);
                    document.body.style.overflow = '';
                } else {
                    // Entrar en pantalla completa
                    const fullscreenDiv = document.createElement('div');
                    fullscreenDiv.className = 'diagram-fullscreen';
                    fullscreenDiv.appendChild(mermaidDiv.cloneNode(true));
                    
                    // Agregar botón de salir
                    const exitBtn = document.createElement('button');
                    exitBtn.innerHTML = '✕';
                    exitBtn.style.cssText = `
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: #e74c3c;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        cursor: pointer;
                        font-size: 20px;
                        z-index: 10001;
                    `;
                    exitBtn.onclick = () => this.toggleFullscreen(index);
                    fullscreenDiv.appendChild(exitBtn);
                    
                    document.body.appendChild(fullscreenDiv);
                    document.body.style.overflow = 'hidden';
                    
                    // Configurar zoom en pantalla completa
                    this.setupZoomAndPan(fullscreenDiv);
                }
            }
        }

        // Inicializar cuando se carga la página
        let diagramController;
        document.addEventListener('DOMContentLoaded', () => {
            diagramController = new DiagramController();
        });
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 40px;
            font-size: 2.5em;
        }
        h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 50px;
            margin-bottom: 20px;
        }
        .diagram-container {
            margin: 30px 0;
            padding: 20px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e1e8ed;
            position: relative;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 1px solid #e1e8ed;
        }
        .zoom-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #3498db;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        .zoom-btn:active {
            transform: scale(0.95);
        }
        .zoom-level {
            font-size: 12px;
            text-align: center;
            color: #666;
            margin: 2px 0;
            font-weight: 500;
        }
        .fullscreen-btn {
            background: #e74c3c;
        }
        .fullscreen-btn:hover {
            background: #c0392b;
        }
        .diagram-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .diagram-fullscreen .mermaid {
            max-width: 95vw;
            max-height: 95vh;
            background: white;
        }
        .description {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }
        .mermaid {
            display: flex;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: grab;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            background: #fafbfc;
        }
        .mermaid:active {
            cursor: grabbing;
        }
        .mermaid svg {
            transition: transform 0.2s ease;
            max-width: none !important;
            max-height: none !important;
        }
        .toc {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .toc ul {
            list-style-type: none;
            padding-left: 0;
        }
        .toc li {
            margin: 8px 0;
        }
        .toc a {
            color: #2980b9;
            text-decoration: none;
            font-weight: 500;
        }
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 Frontend Architecture - GPX Application</h1>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2196f3;">
            <h3 style="margin: 0 0 10px 0; color: #1565c0;">🎮 Controles Interactivos</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px;">
                <div><strong>🔍 Zoom:</strong> Botones +/- o rueda del mouse</div>
                <div><strong>🏠 Reset:</strong> Botón de casa para volver al tamaño original</div>
                <div><strong>🖱️ Arrastrar:</strong> Click y arrastra para mover el diagrama</div>
                <div><strong>🖥️ Pantalla Completa:</strong> Botón rojo para vista ampliada</div>
            </div>
        </div>
        
        <div class="toc">
            <h3>📋 Tabla de Contenidos</h3>
            <ul>
                <li><a href="#architecture">1. Arquitectura General del Frontend</a></li>
                <li><a href="#auth-flow">2. Flujo de Autenticación</a></li>
                <li><a href="#component-structure">3. Estructura de Componentes</a></li>
                <li><a href="#navigation-flow">4. Flujo de Navegación</a></li>
                <li><a href="#state-management">5. Gestión de Estado</a></li>
                <li><a href="#api-communication">6. Comunicación con API</a></li>
                <li><a href="#admin-flows">7. Flujos de Administración</a></li>
                <li><a href="#user-flows">8. Flujos de Usuario</a></li>
                <li><a href="#file-upload">9. Sistema de Subida de Archivos</a></li>
                <li><a href="#error-handling">10. Manejo de Errores</a></li>
            </ul>
        </div>

        <section id="architecture">
            <h2>1. 🏗️ Arquitectura General del Frontend</h2>
            <div class="description">
                <strong>Descripción:</strong> Esta es la arquitectura de alto nivel del frontend, mostrando la organización de carpetas y la separación de responsabilidades siguiendo el patrón Atomic Design.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph "Frontend (Next.js 14)"
                        subgraph "📁 src/"
                            subgraph "🎯 app/ (App Router)"
                                A1[page.tsx - Dashboard]
                                A2[layout.tsx - Root Layout]
                                A3[globals.css - Estilos]
                                
                                subgraph "📁 Rutas"
                                    R1[admin/ - Administración]
                                    R2[login/ - Autenticación]
                                    R3[perfil/ - Perfil Usuario]
                                    R4[eventos/ - Eventos]
                                    R5[vehiculos/ - Vehículos]
                                end
                            end
                            
                            subgraph "🧩 components/ (Atomic Design)"
                                subgraph "⚛️ atoms/"
                                    AT1[button.tsx]
                                    AT2[input.tsx]
                                    AT3[card.tsx]
                                    AT4[badge.tsx]
                                end
                                
                                subgraph "🔬 molecules/"
                                    M1[SidebarNavigation]
                                    M2[PasswordChangeForm]
                                    M3[AuthGuard]
                                end
                                
                                subgraph "🦠 organisms/"
                                    O1[ProfileHeader]
                                    O2[ProfileSections]
                                    O3[admin/UsersManagement]
                                    O4[admin/EventsManagement]
                                    O5[admin/StagesManagement]
                                end
                            end
                            
                            subgraph "🔧 utils/"
                                U1[authFetch.ts]
                                U2[auth.utils.ts]
                                U3[localStorage.ts]
                            end
                            
                            subgraph "🎣 hooks/"
                                H1[useAuth.ts]
                                H2[useLocalStorage.ts]
                            end
                            
                            subgraph "📝 types/"
                                T1[auth.types.ts]
                                T2[profile.types.ts]
                            end
                            
                            subgraph "🌐 contexts/"
                                C1[AuthContext.tsx]
                            end
                        end
                    end
                    
                    subgraph "🔌 External Services"
                        API[Backend API]
                        GOOGLE[Google OAuth2]
                        STORAGE[Local Storage]
                    end
                    
                    A1 --> O3
                    A1 --> O4
                    A1 --> O5
                    O3 --> M1
                    O4 --> AT1
                    O5 --> AT2
                    
                    H1 --> C1
                    U1 --> API
                    C1 --> GOOGLE
                    H2 --> STORAGE
                </div>
            </div>
        </section>

        <section id="auth-flow">
            <h2>2. 🔐 Flujo de Autenticación</h2>
            <div class="description">
                <strong>Descripción:</strong> Diagrama que muestra el flujo completo de autenticación, incluyendo login local y OAuth2 con Google, así como la gestión de tokens JWT.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    START([Usuario accede a la app]) --> CHECK{¿Token válido?}
                    
                    CHECK -->|Sí| DASHBOARD[Dashboard]
                    CHECK -->|No| LOGIN[Página de Login]
                    
                    subgraph "🔑 Opciones de Login"
                        LOGIN --> LOCAL[Login Local]
                        LOGIN --> OAUTH[Login con Google]
                    end
                    
                    subgraph "🏠 Login Local"
                        LOCAL --> EMAIL[Ingresa email/password]
                        EMAIL --> VALIDATE[Validar en backend]
                        VALIDATE -->|✅ Éxito| TOKEN[Recibe JWT Token]
                        VALIDATE -->|❌ Error| ERROR1[Mostrar error]
                        ERROR1 --> EMAIL
                    end
                    
                    subgraph "🌐 OAuth2 Google"
                        OAUTH --> REDIRECT[Redirige a Google]
                        REDIRECT --> GOOGLE_AUTH[Autenticación Google]
                        GOOGLE_AUTH --> CALLBACK[Callback OAuth2]
                        CALLBACK --> PROFILE_CHECK{¿Perfil completo?}
                        PROFILE_CHECK -->|No| COMPLETE[Completar perfil]
                        PROFILE_CHECK -->|Sí| TOKEN2[Recibe JWT Token]
                        COMPLETE --> TOKEN2
                    end
                    
                    TOKEN --> STORE[Guardar en localStorage]
                    TOKEN2 --> STORE
                    STORE --> SET_CONTEXT[Actualizar AuthContext]
                    SET_CONTEXT --> DASHBOARD
                    
                    subgraph "🛡️ Protección de Rutas"
                        DASHBOARD --> GUARD[AuthGuard]
                        GUARD --> ADMIN_CHECK{¿Es admin?}
                        ADMIN_CHECK -->|Sí| ADMIN_ROUTES[Rutas de Admin]
                        ADMIN_CHECK -->|No| USER_ROUTES[Rutas de Usuario]
                        GUARD --> REFRESH[Auto-refresh token]
                    end
                    
                    subgraph "📤 Logout"
                        LOGOUT[Logout] --> CLEAR[Limpiar localStorage]
                        CLEAR --> RESET[Reset AuthContext]
                        RESET --> LOGIN
                    end
                    
                    ADMIN_ROUTES --> LOGOUT
                    USER_ROUTES --> LOGOUT
                </div>
            </div>
        </section>

        <section id="component-structure">
            <h2>3. 🧩 Estructura de Componentes</h2>
            <div class="description">
                <strong>Descripción:</strong> Organización jerárquica de componentes siguiendo Atomic Design, mostrando cómo se componen los elementos desde átomos hasta organismos complejos.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph "⚛️ ATOMS (Elementos básicos)"
                        A1[Button]
                        A2[Input]
                        A3[Card]
                        A4[Badge]
                        A5[Label]
                        A6[Checkbox]
                        A7[Select]
                        A8[Textarea]
                    end
                    
                    subgraph "🔬 MOLECULES (Grupos funcionales)"
                        M1[SidebarNavigation]
                        M2[PasswordChangeForm]
                        M3[SearchInput]
                        M4[ColumnSelector]
                        M5[FileUploader]
                        M6[AuthGuard]
                        
                        M1 --> A1
                        M1 --> A4
                        M2 --> A2
                        M2 --> A1
                        M3 --> A2
                        M4 --> A6
                        M4 --> A5
                        M5 --> A2
                        M5 --> A1
                    end
                    
                    subgraph "🦠 ORGANISMS (Componentes complejos)"
                        O1[ProfileHeader]
                        O2[ProfileSections]
                        O3[UsersManagement]
                        O4[EventsManagement]
                        O5[StagesManagement]
                        O6[VehiclesManagement]
                        
                        O1 --> M5
                        O1 --> A3
                        O2 --> M2
                        O2 --> A8
                        O3 --> M4
                        O3 --> M3
                        O4 --> M4
                        O4 --> M5
                        O5 --> M4
                        O6 --> M3
                    end
                    
                    subgraph "📄 TEMPLATES/PAGES"
                        P1[Dashboard Page]
                        P2[Profile Page]
                        P3[Admin Page]
                        P4[Login Page]
                        
                        P1 --> O3
                        P1 --> O4
                        P1 --> O5
                        P2 --> O1
                        P2 --> O2
                        P3 --> O3
                        P3 --> O4
                        P3 --> O5
                        P3 --> O6
                        P4 --> M2
                    end
                    
                    subgraph "🎣 HOOKS (Lógica reutilizable)"
                        H1[useAuth]
                        H2[useLocalStorage]
                        H3[useDebounce]
                        
                        O3 --> H1
                        O4 --> H1
                        M3 --> H3
                        M6 --> H1
                        P2 --> H2
                    end
                </div>
            </div>
        </section>

        <section id="navigation-flow">
            <h2>4. 🧭 Flujo de Navegación</h2>
            <div class="description">
                <strong>Descripción:</strong> Mapa de navegación de la aplicación mostrando todas las rutas disponibles y las restricciones de acceso basadas en roles.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    ROOT[Raiz] --> AUTH_CHECK{Autenticado?}
                    
                    AUTH_CHECK -->|No| LOGIN[login]
                    AUTH_CHECK -->|Si| DASHBOARD[dashboard]
                    
                    subgraph PUBLIC["Rutas Publicas"]
                        LOGIN --> LOGIN_FORM[Formulario de Login]
                        LOGIN --> OAUTH_BTN[Boton OAuth Google]
                        OAUTH_BTN --> GOOGLE_FLOW[Flujo Google OAuth]
                        GOOGLE_FLOW --> CALLBACK[auth callback]
                        CALLBACK --> PROFILE_COMPLETE[complete profile]
                    end
                    
                    subgraph PROTECTED["Rutas Protegidas Usuario Autenticado"]
                        DASHBOARD --> PROFILE[perfil]
                        DASHBOARD --> VEHICLES[vehiculos]
                        DASHBOARD --> EVENTS[eventos]
                        
                        PROFILE --> PROFILE_TABS[Pestanas de Perfil]
                        PROFILE_TABS --> PERSONAL[Informacion Personal]
                        PROFILE_TABS --> MEDICAL[Informacion Medica]
                        PROFILE_TABS --> EMERGENCY[Contacto Emergencia]
                        PROFILE_TABS --> SOCIAL[Redes Sociales]
                        PROFILE_TABS --> SECURITY[Seguridad]
                        
                        VEHICLES --> VEHICLE_LIST[Lista de Vehiculos]
                        VEHICLE_LIST --> VEHICLE_FORM[Crear Editar Vehiculo]
                        
                        EVENTS --> EVENT_LIST[Lista de Eventos]
                        EVENT_LIST --> EVENT_DETAIL[Detalle de Evento]
                        EVENT_DETAIL --> CLASSIFICATIONS[Clasificaciones]
                        EVENT_DETAIL --> RESULTS[Resultados]
                    end
                    
                    subgraph ADMIN_SECTION["Rutas de Administrador"]
                        DASHBOARD --> ADMIN_CHECK{Es Admin?}
                        ADMIN_CHECK -->|Si| ADMIN[admin]
                        ADMIN_CHECK -->|No| ACCESS_DENIED[Acceso Denegado]
                        
                        ADMIN --> ADMIN_TABS[Pestanas de Admin]
                        ADMIN_TABS --> USERS_MGMT[Gestion de Usuarios]
                        ADMIN_TABS --> EVENTS_MGMT[Gestion de Eventos]
                        ADMIN_TABS --> STAGES_MGMT[Gestion de Etapas]
                        ADMIN_TABS --> VEHICLES_MGMT[Gestion de Vehiculos]
                        ADMIN_TABS --> CATEGORIES_MGMT[Gestion de Categorias]
                        
                        USERS_MGMT --> USER_DETAIL[Detalle de Usuario]
                        EVENTS_MGMT --> EVENT_FORM[Crear Editar Evento]
                        EVENTS_MGMT --> EVENT_IMAGE[Gestion de Imagenes]
                        STAGES_MGMT --> STAGE_FORM[Crear Editar Etapa]
                    end
                    
                    subgraph EXIT["Salida"]
                        LOGOUT[Logout] --> CLEAR_SESSION[Limpiar Sesion]
                        CLEAR_SESSION --> LOGIN
                    end
                    
                    DASHBOARD --> LOGOUT
                    PROFILE --> LOGOUT
                    ADMIN --> LOGOUT
                </div>
            </div>
        </section>

        <section id="state-management">
            <h2>5. 📊 Gestión de Estado</h2>
            <div class="description">
                <strong>Descripción:</strong> Arquitectura de gestión de estado mostrando cómo se maneja la información del usuario, tokens de autenticación y datos de la aplicación.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                graph TB
                    subgraph AUTH_CONTEXT["AuthContext Estado Global"]
                        AC[AuthContext Provider]
                        AC --> USER[user User null]
                        AC --> LOADING[isLoading boolean]
                        AC --> AUTH[isAuthenticated boolean]
                        AC --> REFRESH[refreshUserData function]
                    end
                    
                    subgraph LOCAL_STORAGE["LocalStorage Persistencia"]
                        LS[localStorage]
                        LS --> TOKEN[auth_token]
                        LS --> USER_DATA[user_data]
                        LS --> PREFERENCES[user_preferences]
                    end
                    
                    subgraph HOOKS["Hooks Personalizados"]
                        UA[useAuth]
                        ULS[useLocalStorage]
                        UD[useDebounce]
                        
                        UA --> AC
                        ULS --> LS
                    end
                    
                    subgraph LOCAL_STATE["Estado Local de Componentes"]
                        subgraph USERS_MGMT["UsersManagement"]
                            UM_USERS[users User array]
                            UM_LOADING[loading boolean]
                            UM_SELECTED[selectedUser User]
                            UM_DIALOG[isDialogOpen boolean]
                            UM_COLUMNS[visibleColumns string array]
                        end
                        
                        subgraph EVENTS_MGMT["EventsManagement"]
                            EM_EVENTS[events Event array]
                            EM_CATEGORIES[eventCategories EventCategory array]
                            EM_UPLOADING[uploading boolean]
                            EM_IMAGE_DIALOG[isImageDialogOpen boolean]
                        end
                        
                        subgraph STAGES_MGMT["StagesManagement"]
                            SM_STAGES[stages Stage array]
                            SM_EVENTS[events Event array]
                            SM_SELECTED_EVENT[selectedEventId number]
                            SM_FORM[formData Partial NewStage]
                        end
                    end
                    
                    subgraph UPDATE_FLOWS["Flujos de Actualizacion"]
                        API_CALL[API Call] --> UPDATE_LOCAL[Actualizar Estado Local]
                        UPDATE_LOCAL --> UPDATE_CONTEXT[Actualizar Context si necesario]
                        UPDATE_CONTEXT --> PERSIST[Persistir en localStorage]
                        PERSIST --> RERENDER[Re-render Componentes]
                    end
                    
                    subgraph STATE_EVENTS["Eventos de Estado"]
                        LOGIN_EVENT[Login Success] --> SET_USER[Set User Data]
                        SET_USER --> SAVE_TOKEN[Save Token]
                        LOGOUT_EVENT[Logout] --> CLEAR_USER[Clear User Data]
                        CLEAR_USER --> REMOVE_TOKEN[Remove Token]
                        TOKEN_REFRESH[Token Refresh] --> UPDATE_TOKEN[Update Token]
                    end
                    
                    UA --> UM_USERS
                    UA --> EM_EVENTS
                    ULS --> TOKEN
                    UD --> UM_USERS
                </div>
            </div>
        </section>

        <section id="api-communication">
            <h2>6. 🌐 Comunicación con API</h2>
            <div class="description">
                <strong>Descripción:</strong> Arquitectura de comunicación con el backend, incluyendo autenticación, manejo de errores y interceptores de peticiones.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                sequenceDiagram
                    participant UI as Frontend UI
                    participant AUTH as authFetch()
                    participant LS as localStorage
                    participant API as Backend API
                    participant DB as Database
                    
                    Note over UI,DB: 🔄 Flujo de Petición Autenticada
                    
                    UI->>AUTH: Hacer petición (url, options)
                    AUTH->>LS: Obtener token JWT
                    LS-->>AUTH: Token JWT
                    
                    alt Token existe
                        AUTH->>AUTH: Agregar Authorization header
                        AUTH->>API: Petición con Bearer token
                        
                        alt Token válido
                            API->>DB: Ejecutar operación
                            DB-->>API: Resultado
                            API-->>AUTH: Respuesta 200 + datos
                            AUTH-->>UI: Datos procesados
                        else Token expirado/inválido
                            API-->>AUTH: Respuesta 401 Unauthorized
                            AUTH->>LS: Limpiar token inválido
                            AUTH->>UI: Redirigir a login
                        end
                        
                    else Token no existe
                        AUTH->>UI: Redirigir a login
                    end
                    
                    Note over UI,DB: 🔐 Flujo de Login
                    
                    UI->>API: POST /api/users/login
                    API->>DB: Validar credenciales
                    DB-->>API: Usuario validado
                    API-->>UI: JWT token + datos usuario
                    UI->>LS: Guardar token
                    UI->>UI: Actualizar AuthContext
                    
                    Note over UI,DB: 📤 Flujo de Subida de Archivos
                    
                    UI->>AUTH: FormData con archivo
                    AUTH->>LS: Obtener token
                    AUTH->>API: PUT /api/events/{id}/picture
                    API->>API: Validar archivo (tipo, tamaño)
                    API->>API: Guardar archivo en uploads/
                    API->>DB: Actualizar ruta en BD
                    DB-->>API: Confirmación
                    API-->>AUTH: Evento actualizado
                    AUTH-->>UI: Actualizar UI
                </div>
            </div>
        </section>

        <section id="admin-flows">
            <h2>7. 👑 Flujos de Administración</h2>
            <div class="description">
                <strong>Descripción:</strong> Flujos específicos para las funcionalidades de administración, incluyendo gestión de usuarios, eventos y etapas.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    ADMIN_LOGIN[Admin Login] --> VERIFY_ADMIN{¿Es Admin?}
                    VERIFY_ADMIN -->|No| ACCESS_DENIED[Acceso Denegado]
                    VERIFY_ADMIN -->|Sí| ADMIN_DASHBOARD[Panel de Administración]
                    
                    ADMIN_DASHBOARD --> USERS_TAB[Gestión de Usuarios]
                    ADMIN_DASHBOARD --> EVENTS_TAB[Gestión de Eventos]
                    ADMIN_DASHBOARD --> STAGES_TAB[Gestión de Etapas]
                    
                    subgraph "👥 Gestión de Usuarios"
                        USERS_TAB --> LOAD_USERS[Cargar lista de usuarios]
                        LOAD_USERS --> USERS_TABLE[Tabla con columnas configurables]
                        USERS_TABLE --> SEARCH_USERS[Búsqueda en tiempo real]
                        USERS_TABLE --> VIEW_USER[Ver detalles de usuario]
                        USERS_TABLE --> TOGGLE_ADMIN[Cambiar rol admin]
                        
                        VIEW_USER --> USER_MODAL[Modal con información completa]
                        USER_MODAL --> PERSONAL_INFO[Información Personal]
                        USER_MODAL --> MEDICAL_INFO[Información Médica]
                        USER_MODAL --> SOCIAL_INFO[Redes Sociales]
                        USER_MODAL --> VEHICLES_INFO[Vehículos del Usuario]
                        
                        TOGGLE_ADMIN --> CONFIRM_CHANGE[Confirmar cambio]
                        CONFIRM_CHANGE --> UPDATE_USER[Actualizar usuario en BD]
                        UPDATE_USER --> REFRESH_USERS[Refrescar lista]
                    end
                    
                    subgraph "📅 Gestión de Eventos"
                        EVENTS_TAB --> LOAD_EVENTS[Cargar eventos]
                        LOAD_EVENTS --> EVENTS_TABLE[Tabla de eventos]
                        EVENTS_TABLE --> CREATE_EVENT[Crear nuevo evento]
                        EVENTS_TABLE --> EDIT_EVENT[Editar evento]
                        EVENTS_TABLE --> DELETE_EVENT[Eliminar evento]
                        EVENTS_TABLE --> MANAGE_IMAGE[Gestionar imagen]
                        
                        CREATE_EVENT --> EVENT_FORM[Formulario de evento]
                        EDIT_EVENT --> EVENT_FORM
                        EVENT_FORM --> SAVE_EVENT[Guardar evento]
                        
                        MANAGE_IMAGE --> IMAGE_MODAL[Modal de imagen]
                        IMAGE_MODAL --> UPLOAD_FILE[Subir archivo]
                        IMAGE_MODAL --> URL_IMAGE[URL de imagen]
                        IMAGE_MODAL --> DELETE_IMAGE[Eliminar imagen]
                        
                        UPLOAD_FILE --> VALIDATE_IMAGE[Validar tipo y tamaño]
                        VALIDATE_IMAGE --> SAVE_IMAGE[Guardar en servidor]
                        URL_IMAGE --> UPDATE_URL[Actualizar URL]
                        DELETE_IMAGE --> REMOVE_FILE[Eliminar archivo]
                    end
                    
                    subgraph "🏁 Gestión de Etapas"
                        STAGES_TAB --> SELECT_EVENT[Seleccionar evento]
                        SELECT_EVENT --> LOAD_STAGES[Cargar etapas del evento]
                        LOAD_STAGES --> STAGES_TABLE[Tabla de etapas]
                        STAGES_TABLE --> CREATE_STAGE[Crear etapa]
                        STAGES_TABLE --> EDIT_STAGE[Editar etapa]
                        STAGES_TABLE --> DELETE_STAGE[Eliminar etapa]
                        
                        CREATE_STAGE --> STAGE_FORM[Formulario de etapa]
                        EDIT_STAGE --> STAGE_FORM
                        STAGE_FORM --> STAGE_DATA[Nombre, Orden, Neutralizada]
                        STAGE_DATA --> SAVE_STAGE[Guardar etapa]
                    end
                </div>
            </div>
        </section>

        <section id="user-flows">
            <h2>8. 👤 Flujos de Usuario</h2>
            <div class="description">
                <strong>Descripción:</strong> Flujos específicos para usuarios regulares, incluyendo gestión de perfil, vehículos y visualización de eventos.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    USER_LOGIN[Usuario Login] --> USER_DASHBOARD[Dashboard Usuario]
                    
                    USER_DASHBOARD --> PROFILE_SECTION[Mi Perfil]
                    USER_DASHBOARD --> VEHICLES_SECTION[Mis Vehículos]
                    USER_DASHBOARD --> EVENTS_SECTION[Eventos]
                    
                    subgraph "👤 Gestión de Perfil"
                        PROFILE_SECTION --> PROFILE_TABS[Pestañas de Perfil]
                        
                        PROFILE_TABS --> PERSONAL_TAB[Información Personal]
                        PERSONAL_TAB --> EDIT_PERSONAL[Editar datos personales]
                        EDIT_PERSONAL --> VALIDATE_PERSONAL[Validar datos]
                        VALIDATE_PERSONAL --> SAVE_PERSONAL[Guardar cambios]
                        
                        PROFILE_TABS --> MEDICAL_TAB[Información Médica]
                        MEDICAL_TAB --> EDIT_MEDICAL[Editar info médica]
                        MEDICAL_TAB --> UPLOAD_INSURANCE[Subir seguro médico]
                        
                        PROFILE_TABS --> EMERGENCY_TAB[Contacto Emergencia]
                        EMERGENCY_TAB --> EDIT_EMERGENCY[Editar contacto]
                        
                        PROFILE_TABS --> SOCIAL_TAB[Redes Sociales]
                        SOCIAL_TAB --> EDIT_SOCIAL[Editar redes sociales]
                        
                        PROFILE_TABS --> SECURITY_TAB[Seguridad]
                        SECURITY_TAB --> CHANGE_PASSWORD[Cambiar contraseña]
                        CHANGE_PASSWORD --> VERIFY_CURRENT[Verificar contraseña actual]
                        VERIFY_CURRENT --> SET_NEW[Establecer nueva contraseña]
                        
                        PROFILE_TABS --> UPDATE_PHOTO[Actualizar foto]
                        UPDATE_PHOTO --> PHOTO_OPTIONS[Subir archivo o URL]
                    end
                    
                    subgraph "🚗 Gestión de Vehículos"
                        VEHICLES_SECTION --> VEHICLES_LIST[Lista de mis vehículos]
                        VEHICLES_LIST --> ADD_VEHICLE[Agregar vehículo]
                        VEHICLES_LIST --> EDIT_VEHICLE[Editar vehículo]
                        VEHICLES_LIST --> DELETE_VEHICLE[Eliminar vehículo]
                        
                        ADD_VEHICLE --> VEHICLE_FORM[Formulario de vehículo]
                        EDIT_VEHICLE --> VEHICLE_FORM
                        VEHICLE_FORM --> VEHICLE_DATA[Nombre, Placas, SOAT, Categoría]
                        VEHICLE_DATA --> SAVE_VEHICLE[Guardar vehículo]
                        
                        DELETE_VEHICLE --> CONFIRM_DELETE[Confirmar eliminación]
                        CONFIRM_DELETE --> REMOVE_VEHICLE[Eliminar de BD]
                    end
                    
                    subgraph "📅 Visualización de Eventos"
                        EVENTS_SECTION --> EVENTS_LIST[Lista de eventos]
                        EVENTS_LIST --> FILTER_EVENTS[Filtrar eventos]
                        FILTER_EVENTS --> CURRENT_EVENTS[Eventos actuales]
                        FILTER_EVENTS --> PAST_EVENTS[Eventos pasados]
                        
                        EVENTS_LIST --> EVENT_DETAIL[Detalle de evento]
                        EVENT_DETAIL --> EVENT_INFO[Información del evento]
                        EVENT_DETAIL --> CLASSIFICATIONS[Ver clasificaciones]
                        EVENT_DETAIL --> RESULTS[Ver resultados]
                        
                        CLASSIFICATIONS --> BY_CATEGORY[Por categoría]
                        CLASSIFICATIONS --> BY_STAGE[Por etapa]
                        CLASSIFICATIONS --> GENERAL[General]
                        
                        RESULTS --> STAGE_RESULTS[Resultados por etapa]
                        RESULTS --> TIMES[Tiempos y penalizaciones]
                    end
                </div>
            </div>
        </section>

        <section id="file-upload">
            <h2>9. 📤 Sistema de Subida de Archivos</h2>
            <div class="description">
                <strong>Descripción:</strong> Arquitectura completa del sistema de subida de archivos, incluyendo validaciones, procesamiento y almacenamiento.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    USER_SELECT[Usuario selecciona archivo] --> FILE_INPUT[Input de archivo]
                    
                    FILE_INPUT --> CLIENT_VALIDATION{Validacion Frontend}
                    CLIENT_VALIDATION -->|Error| SHOW_ERROR[Mostrar error al usuario]
                    CLIENT_VALIDATION -->|OK| PREPARE_UPLOAD[Preparar para subida]
                    
                    subgraph CLIENT_VALIDATIONS["Validaciones Frontend"]
                        CV1[Tipo de archivo permitido]
                        CV2[Tamaño maximo 5MB]
                        CV3[Archivo no vacio]
                    end
                    
                    PREPARE_UPLOAD --> CREATE_FORMDATA[Crear FormData]
                    CREATE_FORMDATA --> ADD_METADATA[Agregar metadatos]
                    ADD_METADATA --> SET_LOADING[Mostrar indicador de carga]
                    
                    SET_LOADING --> SEND_REQUEST[Enviar peticion HTTP]
                    SEND_REQUEST --> BACKEND_RECEIVE[Backend recibe archivo]
                    
                    subgraph BACKEND_PROCESSING["Procesamiento Backend"]
                        BACKEND_RECEIVE --> SERVER_VALIDATION{Validacion Servidor}
                        SERVER_VALIDATION -->|Error| RETURN_ERROR[Retornar error]
                        SERVER_VALIDATION -->|OK| GENERATE_NAME[Generar nombre unico]
                        
                        GENERATE_NAME --> CREATE_DIR[Crear directorio si no existe]
                        CREATE_DIR --> SAVE_FILE[Guardar archivo en disco]
                        SAVE_FILE --> UPDATE_DB[Actualizar referencia en BD]
                        UPDATE_DB --> DELETE_OLD[Eliminar archivo anterior]
                        DELETE_OLD --> RETURN_SUCCESS[Retornar exito]
                    end
                    
                    subgraph SERVER_VALIDATIONS["Validaciones Servidor"]
                        SV1[Verificar autenticacion]
                        SV2[Verificar permisos]
                        SV3[Validar tipo MIME]
                        SV4[Verificar tamaño]
                        SV5[Escaneo de seguridad]
                    end
                    
                    RETURN_ERROR --> FRONTEND_ERROR[Frontend recibe error]
                    FRONTEND_ERROR --> HIDE_LOADING[Ocultar carga]
                    FRONTEND_ERROR --> DISPLAY_ERROR[Mostrar mensaje error]
                    
                    RETURN_SUCCESS --> FRONTEND_SUCCESS[Frontend recibe exito]
                    FRONTEND_SUCCESS --> UPDATE_UI[Actualizar interfaz]
                    UPDATE_UI --> REFRESH_DATA[Refrescar datos]
                    REFRESH_DATA --> HIDE_LOADING2[Ocultar carga]
                    HIDE_LOADING2 --> SHOW_SUCCESS[Mostrar mensaje exito]
                    
                    subgraph FILE_TYPES["Tipos de Archivos Soportados"]
                        PROFILE_PICS[Fotos de perfil JPG PNG GIF]
                        EVENT_PICS[Imagenes de eventos JPG PNG GIF]
                        INSURANCE_DOCS[Documentos de seguro PDF JPG PNG]
                    end
                    
                    subgraph STORAGE["Almacenamiento"]
                        UPLOADS_DIR[uploads]
                        USERS_DIR[users]
                        EVENTS_DIR[events]
                        INSURANCE_DIR[insurance]
                        
                        UPLOADS_DIR --> USERS_DIR
                        UPLOADS_DIR --> EVENTS_DIR
                        UPLOADS_DIR --> INSURANCE_DIR
                    end
                </div>
            </div>
        </section>

        <section id="error-handling">
            <h2>10. ⚠️ Manejo de Errores</h2>
            <div class="description">
                <strong>Descripción:</strong> Sistema completo de manejo de errores, incluyendo captura, clasificación y presentación de errores al usuario.
            </div>
            <div class="diagram-container">
                <div class="mermaid">
                flowchart TD
                    ERROR_OCCURS[❌ Error Ocurre] --> ERROR_TYPE{Tipo de Error}
                    
                    ERROR_TYPE -->|🌐 Network| NETWORK_ERROR[Error de Red]
                    ERROR_TYPE -->|🔐 Auth| AUTH_ERROR[Error de Autenticación]
                    ERROR_TYPE -->|✅ Validation| VALIDATION_ERROR[Error de Validación]
                    ERROR_TYPE -->|🔧 Server| SERVER_ERROR[Error del Servidor]
                    ERROR_TYPE -->|💻 Client| CLIENT_ERROR[Error del Cliente]
                    
                    subgraph "🌐 Errores de Red"
                        NETWORK_ERROR --> OFFLINE{¿Sin conexión?}
                        OFFLINE -->|Sí| SHOW_OFFLINE[Mostrar mensaje offline]
                        OFFLINE -->|No| RETRY_REQUEST[Reintentar petición]
                        RETRY_REQUEST --> MAX_RETRIES{¿Máx. reintentos?}
                        MAX_RETRIES -->|No| WAIT_RETRY[Esperar y reintentar]
                        MAX_RETRIES -->|Sí| SHOW_NETWORK_ERROR[Mostrar error de red]
                    end
                    
                    subgraph "🔐 Errores de Autenticación"
                        AUTH_ERROR --> TOKEN_EXPIRED{¿Token expirado?}
                        TOKEN_EXPIRED -->|Sí| REFRESH_TOKEN[Intentar refresh token]
                        TOKEN_EXPIRED -->|No| INVALID_CREDS[Credenciales inválidas]
                        
                        REFRESH_TOKEN --> REFRESH_SUCCESS{¿Éxito?}
                        REFRESH_SUCCESS -->|Sí| RETRY_ORIGINAL[Reintentar petición original]
                        REFRESH_SUCCESS -->|No| FORCE_LOGOUT[Forzar logout]
                        
                        INVALID_CREDS --> SHOW_LOGIN_ERROR[Mostrar error de login]
                        FORCE_LOGOUT --> CLEAR_SESSION[Limpiar sesión]
                        CLEAR_SESSION --> REDIRECT_LOGIN[Redirigir a login]
                    end
                    
                    subgraph "✅ Errores de Validación"
                        VALIDATION_ERROR --> FIELD_ERRORS[Errores de campo]
                        VALIDATION_ERROR --> FORM_ERRORS[Errores de formulario]
                        
                        FIELD_ERRORS --> HIGHLIGHT_FIELDS[Resaltar campos con error]
                        FIELD_ERRORS --> SHOW_FIELD_MESSAGES[Mostrar mensajes específicos]
                        
                        FORM_ERRORS --> SHOW_FORM_MESSAGE[Mostrar mensaje general]
                        FORM_ERRORS --> PREVENT_SUBMIT[Prevenir envío]
                    end
                    
                    subgraph "🔧 Errores del Servidor"
                        SERVER_ERROR --> STATUS_CODE{Código de estado}
                        STATUS_CODE -->|500| INTERNAL_ERROR[Error interno del servidor]
                        STATUS_CODE -->|404| NOT_FOUND[Recurso no encontrado]
                        STATUS_CODE -->|403| FORBIDDEN[Acceso prohibido]
                        
                        INTERNAL_ERROR --> LOG_ERROR[Registrar error]
                        INTERNAL_ERROR --> SHOW_GENERIC_ERROR[Mostrar error genérico]
                        
                        NOT_FOUND --> SHOW_404[Mostrar página 404]
                        FORBIDDEN --> SHOW_403[Mostrar acceso denegado]
                    end
                    
                    subgraph "💻 Errores del Cliente"
                        CLIENT_ERROR --> JS_ERROR[Error JavaScript]
                        CLIENT_ERROR --> COMPONENT_ERROR[Error de Componente]
                        
                        JS_ERROR --> ERROR_BOUNDARY[Error Boundary]
                        COMPONENT_ERROR --> ERROR_BOUNDARY
                        
                        ERROR_BOUNDARY --> LOG_CLIENT_ERROR[Registrar error cliente]
                        ERROR_BOUNDARY --> SHOW_FALLBACK[Mostrar UI de fallback]
                        ERROR_BOUNDARY --> REPORT_ERROR[Reportar error]
                    end
                    
                    subgraph "📊 Sistema de Notificaciones"
                        TOAST_SUCCESS[🟢 Toast de Éxito]
                        TOAST_WARNING[🟡 Toast de Advertencia]
                        TOAST_ERROR[🔴 Toast de Error]
                        TOAST_INFO[🔵 Toast de Información]
                        
                        SHOW_FIELD_MESSAGES --> TOAST_WARNING
                        SHOW_GENERIC_ERROR --> TOAST_ERROR
                        SHOW_LOGIN_ERROR --> TOAST_ERROR
                        SHOW_NETWORK_ERROR --> TOAST_ERROR
                    end
                    
                    subgraph "🔄 Recuperación de Errores"
                        RETRY_BTN[Botón de Reintentar]
                        REFRESH_PAGE[Refrescar Página]
                        CONTACT_SUPPORT[Contactar Soporte]
                        
                        SHOW_GENERIC_ERROR --> RETRY_BTN
                        SHOW_FALLBACK --> REFRESH_PAGE
                        REPORT_ERROR --> CONTACT_SUPPORT
                    end
                </div>
            </div>
        </section>
        
        <footer style="margin-top: 60px; padding: 30px; background: #34495e; color: white; text-align: center; border-radius: 8px;">
            <h3>📋 Resumen de la Arquitectura Frontend</h3>
            <p>Esta documentación visual cubre la arquitectura completa del frontend de la aplicación GPX, desde la estructura de componentes hasta los flujos de datos y manejo de errores.</p>
            <p><strong>Tecnologías principales:</strong> Next.js 14, React, TypeScript, Tailwind CSS, shadcn/ui</p>
            <p><strong>Patrones utilizados:</strong> Atomic Design, Context API, Custom Hooks, Error Boundaries</p>
            <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
                Generado automáticamente - Mantener actualizado con cambios en la aplicación
            </p>
        </footer>
    </div>

    <script>
        // Configuración de Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#2980b9',
                lineColor: '#34495e',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#bdc3c7'
            }
        });

        // Smooth scrolling para la tabla de contenidos
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Agregar indicador de carga mientras se renderizan los diagramas
        document.addEventListener('DOMContentLoaded', function() {
            const diagrams = document.querySelectorAll('.mermaid');
            diagrams.forEach(diagram => {
                diagram.style.minHeight = '200px';
                diagram.style.display = 'flex';
                diagram.style.alignItems = 'center';
                diagram.style.justifyContent = 'center';
            });
        });
    </script>
</body>
</html> 